<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Students</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <header class="site-header">
        <a class="brand-mark" href="/index.html">14 Stars</a>
        <button class="nav-toggle" type="button" data-nav-toggle data-target="primary-nav" aria-label="Toggle navigation" aria-expanded="false">â˜°</button>
        <nav class="nav-links" id="primary-nav">
            <a class="nav-link" href="/parents/parents_portal.html">Parent Portal</a>
            <a class="nav-link is-active" href="/parents/view_students.html">View Students</a>
            <a class="nav-link" href="/parents/student_registration.html">Register Student</a>
            <button class="btn btn--danger" type="button" onclick="window.location.href='/parents/logout'">Logout</button>
        </nav>
    </header>

    <main class="stack">
        <section class="page-header">
            <div>
                <p class="page-eyebrow">Family Overview</p>
                <h1>Your students</h1>
                <p class="text-muted">Every student linked to your guardian account appears below.</p>
            </div>
            <div class="page-actions">
                <button class="btn btn--ghost" type="button" onclick="window.location.href='student_registration.html'">Add Student</button>
            </div>
        </section>

        <section class="panel panel--narrow">
            <div id="student-info" class="stack">
                <p class="text-muted">Loading your students...</p>
            </div>
        </section>
    </main>

    <footer class="site-footer">
        <p>&copy; 2024 14 Stars Islamic School.</p>
    </footer>

    <script>
        const studentInfoDiv = document.getElementById('student-info');
        document.addEventListener('DOMContentLoaded', loadStudents);
    
        async function loadStudents() {
            try {
                const response = await fetch('/parents/students', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
    
                if (response.status === 401 || response.status === 403) {
                    window.location.href = 'parents_login.html';
                    return;
                }
    
                if (!response.ok) {
                    const errorData = await response.json();
                    studentInfoDiv.innerHTML = `<div class="message message--error">${errorData.message || 'Unable to load students.'}</div>`;
                    return;
                }

                const students = await response.json();
                studentInfoDiv.innerHTML = '';

                if (students.length > 0) {
                    students.forEach(student => {
                        const studentDiv = document.createElement('article');
                        studentDiv.classList.add('card');
                        studentDiv.innerHTML = `
                            <p><strong>Name:</strong> ${student.F_Name} ${student.L_Name}</p>
                            <p><strong>DOB:</strong> ${student.dob ? formatDateOfBirth(student.dob) : 'N/A'}</p>
                            <p><strong>Email:</strong> ${student.st_email}</p>
                            <p><strong>Phone:</strong> ${student.st_cell}</p>
                        `;
                        studentInfoDiv.appendChild(studentDiv);
                    });
                } else {
                    studentInfoDiv.innerHTML = '<p class="text-muted">No students found for your account.</p>';
                }
    
            } catch (error) {
                console.error('Error:', error);
                studentInfoDiv.innerHTML = `<div class="message message--error">Failed to fetch student information.</div>`;
            }
        }
    
        function formatDateOfBirth(dateString) {
            if (!dateString) return 'N/A';

            // Ensure it's a valid date
            const dob = new Date(dateString);
            if (isNaN(dob.getTime())) {
                console.error('Invalid DOB:', dateString);
                return 'Invalid Date';
            }

            // Extract the correct parts (Year-Month-Day)
            const year = dob.getUTCFullYear(); // Use UTC to avoid time zone shifts
            const month = String(dob.getUTCMonth() + 1).padStart(2, '0'); // Ensure two-digit month
            const day = String(dob.getUTCDate()).padStart(2, '0'); // Ensure two-digit day

            return `${year}-${month}-${day}`;
        }
    </script>
    <script src="/scripts/ui.js" defer></script>
</body>
</html>
