<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/styles.css">
    <title>Teachers Portal</title>
</head>
<body>
    <header class="site-header">
        <a class="brand-mark" href="/index.html">14 Stars</a>
        <button class="nav-toggle" type="button" data-nav-toggle data-target="primary-nav" aria-label="Toggle navigation" aria-expanded="false">â˜°</button>
        <nav class="nav-links" id="primary-nav">
            <a class="nav-link" href="/index.html">Home</a>
            <a class="nav-link is-active" href="/teachers/teacher_portal.html">Teacher Portal</a>
            <button class="btn btn--danger" type="button" onclick="window.location.href='/teachers/teacher-logout'">Logout</button>
        </nav>
    </header>

    <main class="stack">
        <section class="page-header">
            <div>
                <p class="page-eyebrow">Faculty Tools</p>
                <h1>Teachers Portal</h1>
                <p class="text-muted">Switch between guardian info, student levels, and teacher details quickly.</p>
            </div>
        </section>

        <section class="panel panel--narrow stack">
            <h2>Quick views</h2>
            <div class="btn-container">
                <button class="btn" onclick="showTable('classes')">Classes</button>
                <button class="btn btn--ghost" onclick="showTable('studentGuardian')">Student &amp; Guardian</button>
                <button class="btn btn--ghost" onclick="showTable('studentLevel')">Student Levels</button>
                <button class="btn btn--ghost" onclick="showTable('teachers')">Teachers</button>
                <button class="btn btn--secondary" onclick="toggleSubstituteForm()">Request Substitute</button>
            </div>
        </section>

        <section id="substitute-form-section" class="panel panel--narrow stack is-hidden">
            <h2>Request a substitute</h2>
            <form action="/substitute-requests/submit" method="POST" class="stack">
                <label for="teacher-name">Teacher Name</label>
                <input type="text" id="teacher-name" name="teacher_name" required>

                <label for="teacher-email">Teacher Email</label>
                <input type="email" id="teacher-email" name="teacher_email" readonly required>

                <label for="reason">Reason for Substitute</label>
                <textarea id="reason" name="reason" rows="4"></textarea>

                <label for="date">Date</label>
                <input type="date" id="date" name="date" required>

                <button class="btn" type="submit">Submit Request</button>
            </form>
        </section>

        <section id="guardian-table-section" class="panel panel--narrow is-hidden">
            <div class="data-table-wrapper">
                <table>
                    <caption>Student &amp; Guardian</caption>
                    <thead>
                        <tr>
                            <th>Student ID</th>
                            <th>Student Name</th>
                            <th>Guardian Name</th>
                            <th>Relationship</th>
                            <th>Cell</th>
                            <th>Email</th>
                        </tr>
                    </thead>
                    <tbody id="guardian-table"></tbody>
                </table>
            </div>
        </section>

        <section id="classes-table-section" class="panel panel--narrow is-hidden">
            <div class="data-table-wrapper">
                <table>
                    <caption>Teacher Class Assignments</caption>
                    <thead>
                        <tr>
                            <th>Teacher</th>
                            <th>Level</th>
                            <th>Subject</th>
                            <th>School Year</th>
                        </tr>
                    </thead>
                    <tbody id="classes-table"></tbody>
                </table>
            </div>
        </section>

        <section id="stud-lvl-table-section" class="panel panel--narrow is-hidden">
            <div class="data-table-wrapper">
                <table>
                    <caption>Student Levels</caption>
                    <thead>
                        <tr>
                            <th>Student ID</th>
                            <th>Student Name</th>
                            <th>Level</th>
                            <th>Subject</th>
                            <th>Term</th>
                            <th>School Year</th>
                            <th>Midterm</th>
                            <th>Final</th>
                            <th>Average</th>
                        </tr>
                    </thead>
                    <tbody id="stud-lvl-table"></tbody>
                </table>
            </div>
        </section>

        <section id="teachers-table-section" class="panel panel--narrow is-hidden">
            <div class="data-table-wrapper">
                <table>
                    <caption>Teachers</caption>
                    <thead>
                        <tr>
                            <th>Full Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                        </tr>
                    </thead>
                    <tbody id="teachers-table"></tbody>
                </table>
            </div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            populateTeacherIdentity();
        });

        const sections = {
            guardian: document.getElementById('guardian-table-section'),
            classes: document.getElementById('classes-table-section'),
            studentLevel: document.getElementById('stud-lvl-table-section'),
            teachers: document.getElementById('teachers-table-section')
        };

        let currentTeacherEmail = '';
        let teacherClassAssignments = [];

        function hideAllSections() {
            Object.values(sections).forEach(section => section.classList.add('is-hidden'));
        }

        function toggleSubstituteForm() {
            const formSection = document.getElementById('substitute-form-section');
            formSection.classList.toggle('is-hidden');
        }

        function fetchStudentGuardianData() {
            fetch('/admins/getStudentGuardianData')
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.getElementById('guardian-table');
                    tableBody.innerHTML = '';

                    data.forEach(entry => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${entry.St_ID}</td>
                            <td>${entry.student_name}</td>
                            <td>${entry.guardian_name || ''}</td>
                            <td>${entry.relationship_type || ''}</td>
                            <td>${entry.g_cell || ''}</td>
                            <td>${entry.g_email || ''}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                    sections.guardian.classList.remove('is-hidden');
                })
                .catch(error => console.error('Error fetching guardian data:', error));
        }

        function fetchAssignedLevelsData() {
            fetch('/student-levels/assigned')
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.getElementById('stud-lvl-table');
                    tableBody.innerHTML = '';

                    data.forEach(entry => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${entry.st_id || 'N/A'}</td>
                            <td>${entry.full_name || 'N/A'}</td>
                            <td>${entry.level_number || 'N/A'}</td>
                            <td>${entry.subject || 'N/A'}</td>
                            <td>${entry.term_name || 'N/A'}</td>
                            <td>${entry.school_year || entry.term_school_year || 'N/A'}</td>
                            <td>${formatGrade(entry.midterm_grade)}</td>
                            <td>${formatGrade(entry.final_grade)}</td>
                            <td>${formatGrade(entry.average_grade)}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                    sections.studentLevel.classList.remove('is-hidden');
                })
                .catch(error => console.error('Error fetching assigned levels data:', error));
        }

        function fetchTeachersData() {
            fetch('/teachers/all')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Unable to load teachers');
                    }
                    return response.json();
                })
                .then(data => {
                    const tableBody = document.getElementById('teachers-table');
                    tableBody.innerHTML = '';

                    (data.teachers || []).forEach(entry => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${entry.full_name || 'N/A'}</td>
                            <td>${entry.t_email || 'N/A'}</td>
                            <td>${entry.t_phone || 'N/A'}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                    sections.teachers.classList.remove('is-hidden');
                })
                .catch(error => console.error('Error fetching teachers data:', error));
        }

        function fetchTeacherClassesData() {
            fetch('/teacher-classes/assigned')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Unable to load teacher-class assignments');
                    }
                    return response.json();
                })
                .then(data => {
                    teacherClassAssignments = Array.isArray(data) ? data : [];
                    renderTeacherClasses();
                    sections.classes.classList.remove('is-hidden');
                })
                .catch(error => console.error('Error fetching teacher-class assignments:', error));
        }

        function getVisibleTeacherAssignments() {
            if (!teacherClassAssignments.length) {
                return [];
            }
            if (!currentTeacherEmail) {
                return teacherClassAssignments;
            }
            const normalized = currentTeacherEmail.toLowerCase();
            const mine = teacherClassAssignments.filter(assignment =>
                (assignment.teacher_email || '').toLowerCase() === normalized
            );
            return mine.length ? mine : teacherClassAssignments;
        }

        function renderTeacherClasses() {
            const tableBody = document.getElementById('classes-table');
            if (!tableBody) {
                return;
            }
            tableBody.innerHTML = '';

            const records = getVisibleTeacherAssignments();
            if (!records.length) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = '<td colspan="4">No assignments recorded yet.</td>';
                tableBody.appendChild(emptyRow);
                return;
            }

            records.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.teacher_name}</td>
                    <td>${record.level_number ? `Level ${record.level_number}` : 'N/A'}</td>
                    <td>${record.subject || 'N/A'}</td>
                    <td>${record.school_year}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        async function populateTeacherIdentity() {
            const emailInput = document.getElementById('teacher-email');
            const nameInput = document.getElementById('teacher-name');
            if (!emailInput) {
                return;
            }

            try {
                const response = await fetch('/teachers/me', { credentials: 'same-origin' });
                if (!response.ok) {
                    throw new Error('Unable to load teacher identity');
                }
                const data = await response.json();
                if (data.success) {
                    emailInput.value = data.email || '';
                    currentTeacherEmail = (data.email || '').trim();
                    if (nameInput && (!nameInput.value || nameInput.value.trim() === '')) {
                        const fullName = [data.first_name, data.last_name].filter(Boolean).join(' ').trim();
                        if (fullName) {
                            nameInput.value = fullName;
                        }
                    }
                    renderTeacherClasses();
                } else {
                    emailInput.removeAttribute('readonly');
                }
            } catch (error) {
                console.error('Error fetching teacher identity:', error);
                emailInput.removeAttribute('readonly');
            }
        }

        function formatGrade(value) {
            if (value === null || value === undefined || value === '') return '';
            const number = Number(value);
            return Number.isFinite(number) ? number.toFixed(2) : '';
        }

        function showTable(table) {
            hideAllSections();

            if (table === 'studentGuardian') {
                fetchStudentGuardianData();
            } else if (table === 'classes') {
                fetchTeacherClassesData();
            } else if (table === 'studentLevel') {
                fetchAssignedLevelsData();
            } else if (table === 'teachers') {
                fetchTeachersData();
            }
        }
    </script>

    <script src="/scripts/ui.js" defer></script>
</body>
</html>
